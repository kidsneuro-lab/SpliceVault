name: Deploy SpliceVault Prod

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  deploy-prod:
    runs-on: ubuntu-latest
    environment: prod  # Specifies the GitHub Environment to use

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2
      
    - name: Prepare Google Analytics file
      run: |
        cp google-analytics-template.html google-analytics.html
        sed -i 's/GA_MEASUREMENT_ID/${{ vars.GA_MEASUREMENT_ID }}/g' google-analytics.html
        
    - name: Prepare config file
      run: |
        cp config-template.yml config.yml
        sed -i 's/DB_HOST/${{ vars.DB_HOST }}/g' config.yml
        sed -i 's/DB_NAME/${{ vars.DB_NAME }}/g' config.yml
        sed -i 's/DB_USER/${{ vars.DB_USER }}/g' config.yml
        sed -i 's/DB_PASSWORD/${{ secrets.DB_PASSWORD }}/g' config.yml

    - name: Set up R
      uses: r-lib/actions/setup-r@v2
      with:
        r-version: '4.2.3'

    - name: Install dependencies
      run: |
        R -e 'install.packages("rsconnect", dependencies = T)'
      
    - name: Deploy to shinyapps.io using Prod environment secrets
      run: |
        R -e 'rsconnect::setAccountInfo(name="${{ vars.SHINYAPPS_ACCOUNT_NAME }}", token="${{ secrets.SHINYAPPS_TOKEN }}", secret="${{ secrets.SHINYAPPS_SECRET }}")'
        R -e 'rsconnect::deployApp(appName="${{ vars.SHINYAPPS_APP_NAME }}", account="${{ vars.SHINYAPPS_ACCOUNT_NAME }}")'
